name: Generate Projects

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:
    inputs:
      tool_name:
        description: 'Specific tool to generate (optional)'
        required: false
        default: ''
        type: string

# ALL API KEYS - Complete automation coverage
env:
  # === GITHUB ===
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
  GH_USERNAME: chirag127

  # === PRIMARY AI PROVIDERS ===
  CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}

  # === BACKUP AI PROVIDERS ===
  MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
  NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # === TREND DISCOVERY APIS ===
  PRODUCT_HUNT_API_KEY: ${{ secrets.PRODUCT_HUNT_API_KEY }}
  REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
  REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
  DEV_TO_API_KEY: ${{ secrets.DEV_TO_API_KEY }}
  NEWSAPI_AI_KEY: ${{ secrets.NEWSAPI_AI_KEY }}
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
  KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
  SEMANTIC_SCHOLAR_API_KEY: ${{ secrets.SEMANTIC_SCHOLAR_API_KEY }}
  UNPAYWALL_EMAIL: ${{ secrets.UNPAYWALL_EMAIL }}

  # === SEARXNG (FREE SEARCH API) ===
  SEARXNG_URL: "https://searx.be/search"

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install requests pydantic httpx aiohttp tiktoken
          pip install -e . || true

      - name: Verify API Keys
        run: |
          echo "Verifying API keys..."
          [ -n "$GH_TOKEN" ] && echo "GH_TOKEN OK" || echo "GH_TOKEN missing"
          [ -n "$CEREBRAS_API_KEY" ] && echo "CEREBRAS_API_KEY OK" || echo "CEREBRAS_API_KEY missing"
          [ -n "$GROQ_API_KEY" ] && echo "GROQ_API_KEY OK" || echo "GROQ_API_KEY (optional)"
          [ -n "$GEMINI_API_KEY" ] && echo "GEMINI_API_KEY OK" || echo "GEMINI_API_KEY (optional)"

      - name: Generate tool
        run: |
          if [ -n "${{ github.event.inputs.tool_name }}" ]; then
            echo "Generating: ${{ github.event.inputs.tool_name }}"
            python scripts/generate_projects.py --tool "${{ github.event.inputs.tool_name }}"
          else
            echo "Generating next tool from config/ar.txt"
            python scripts/generate_projects.py
          fi

      - name: Show status
        run: python scripts/generate_projects.py --status

      - name: Commit state
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add state/
          git diff --staged --quiet || git commit -m "chore: update generation state"
          git push || true
