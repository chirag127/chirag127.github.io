name: Daily Repository Factory

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:
    inputs:
      max_repos:
        description: 'Maximum repositories to create'
        required: false
        default: '5'
        type: string
      dry_run:
        description: 'Dry run mode (no actual creation)'
        required: false
        default: 'false'
        type: boolean
      optimize_only:
        description: 'Only optimize existing repos'
        required: false
        default: 'false'
        type: boolean

# ALL API KEYS - Complete automation coverage
env:
  # === GITHUB ===
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
  GH_USERNAME: chirag127

  # === JULES AI ===
  JULES_API_KEY: ${{ secrets.JULES_API_KEY }}

  # === PRIMARY AI PROVIDERS ===
  CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}

  # === BACKUP AI PROVIDERS ===
  MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
  NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # === TREND DISCOVERY APIS ===
  PRODUCT_HUNT_API_KEY: ${{ secrets.PRODUCT_HUNT_API_KEY }}
  REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
  REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
  DEV_TO_API_KEY: ${{ secrets.DEV_TO_API_KEY }}
  NEWSAPI_AI_KEY: ${{ secrets.NEWSAPI_AI_KEY }}
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
  KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
  SEMANTIC_SCHOLAR_API_KEY: ${{ secrets.SEMANTIC_SCHOLAR_API_KEY }}
  UNPAYWALL_EMAIL: ${{ secrets.UNPAYWALL_EMAIL }}

  # === SEARXNG (FREE SEARCH API) ===
  SEARXNG_URL: "https://searx.be/search"

jobs:
  daily-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync

      - name: Verify API Keys
        run: |
          echo "üîë Verifying API keys..."
          [ -n "$GH_TOKEN" ] && echo "‚úÖ GH_TOKEN" || echo "‚ùå GH_TOKEN missing"
          [ -n "$JULES_API_KEY" ] && echo "‚úÖ JULES_API_KEY" || echo "‚ö†Ô∏è JULES_API_KEY (optional)"
          [ -n "$CEREBRAS_API_KEY" ] && echo "‚úÖ CEREBRAS_API_KEY" || echo "‚ùå CEREBRAS_API_KEY missing"
          [ -n "$GROQ_API_KEY" ] && echo "‚úÖ GROQ_API_KEY" || echo "‚ö†Ô∏è GROQ_API_KEY"
          [ -n "$GEMINI_API_KEY" ] && echo "‚úÖ GEMINI_API_KEY" || echo "‚ö†Ô∏è GEMINI_API_KEY"
          [ -n "$MISTRAL_API_KEY" ] && echo "‚úÖ MISTRAL_API_KEY" || echo "‚ö†Ô∏è MISTRAL_API_KEY"
          [ -n "$NVIDIA_API_KEY" ] && echo "‚úÖ NVIDIA_API_KEY" || echo "‚ö†Ô∏è NVIDIA_API_KEY"
          [ -n "$CLOUDFLARE_API_TOKEN" ] && echo "‚úÖ CLOUDFLARE_API_TOKEN" || echo "‚ö†Ô∏è CLOUDFLARE_API_TOKEN"
          [ -n "$HF_TOKEN" ] && echo "‚úÖ HF_TOKEN" || echo "‚ö†Ô∏è HF_TOKEN"
          echo "üåê SEARXNG_URL: $SEARXNG_URL"

      - name: Run Daily Factory (Full Mode)
        if: ${{ github.event.inputs.dry_run != 'true' && github.event.inputs.optimize_only != 'true' }}
        run: |
          uv run python joules_daily_runner.py \
            --max-repos ${{ github.event.inputs.max_repos || '5' }}

      - name: Run Daily Factory (Dry Run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          uv run python joules_daily_runner.py \
            --dry-run \
            --max-repos ${{ github.event.inputs.max_repos || '5' }}

      - name: Run Daily Factory (Optimize Only)
        if: ${{ github.event.inputs.optimize_only == 'true' }}
        run: |
          uv run python joules_daily_runner.py --optimize

      - name: Run PR Batch Merger
        if: ${{ github.event.inputs.dry_run != 'true' }}
        continue-on-error: true
        run: |
          uv run python pr_batch_merger.py --no-dry-run --max-prs 50

      - name: Upload execution report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-report-${{ github.run_id }}
          path: |
            budget_state.json
            pending_repos.json
            *.log
          retention-days: 30

      - name: Commit state files
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add budget_state.json pending_repos.json
          git diff --staged --quiet || git commit -m "chore: update daily factory state [skip ci]"
          git push
