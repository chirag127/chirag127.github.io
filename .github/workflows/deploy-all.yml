# ==============================================================================
# Multi-Platform Deployment - GitHub Actions Workflow
# ==============================================================================
# Deploys static site to 10+ hosting platforms simultaneously.
#
# ENABLE FLAGS: Set in GitHub Repository Variables (not Secrets)
# - All platforms disabled by default for safety
# - GitHub Pages is ALWAYS enabled (priority)
# ==============================================================================

name: Deploy to All Platforms

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force deploy to all platforms (ignore ENABLE flags)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# Cancel previous runs on same branch
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # BUILD JOB - Prepares the site for deployment
  # ==========================================================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: |
            .
            !.git
            !.github
            !node_modules
            !scripts
            !.env*
            !__pycache__
            !*.pyc
          retention-days: 1

  # ==========================================================================
  # GITHUB PAGES (ALWAYS ENABLED - Priority 1)
  # ==========================================================================
  deploy-github-pages:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: .

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ==========================================================================
  # NETLIFY (Priority 2)
  # ==========================================================================
  deploy-netlify:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_NETLIFY == 'true' || github.event.inputs.force_all == 'true' }}
    continue-on-error: true
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: ./dist

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3
        if: ${{ secrets.NETLIFY_AUTH_TOKEN != '' && secrets.NETLIFY_SITE_ID != '' }}
        with:
          publish-dir: ./dist
          production-deploy: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # ==========================================================================
  # VERCEL (Priority 3)
  # ==========================================================================
  deploy-vercel:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_VERCEL == 'true' || github.event.inputs.force_all == 'true' }}
    continue-on-error: true
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: ./dist

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        if: ${{ secrets.VERCEL_TOKEN != '' }}
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./dist
          vercel-args: '--prod'

  # ==========================================================================
  # CLOUDFLARE PAGES (Priority 4)
  # ==========================================================================
  deploy-cloudflare:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_CLOUDFLARE == 'true' || github.event.inputs.force_all == 'true' }}
    continue-on-error: true
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: ./dist

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' && secrets.CLOUDFLARE_ACCOUNT_ID != '' }}
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./dist --project-name=${{ vars.CLOUDFLARE_PROJECT_NAME || 'chirag-hub' }}

  # ==========================================================================
  # SURGE.SH (Priority 5)
  # ==========================================================================
  deploy-surge:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_SURGE == 'true' || github.event.inputs.force_all == 'true' }}
    continue-on-error: true
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: ./dist

      - name: Deploy to Surge
        if: ${{ secrets.SURGE_TOKEN != '' }}
        run: |
          npm install -g surge
          surge ./dist ${{ vars.SURGE_DOMAIN || 'chirag127.surge.sh' }} --token ${{ secrets.SURGE_TOKEN }}

  # ==========================================================================
  # RENDER (Priority 6)
  # ==========================================================================
  deploy-render:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_RENDER == 'true' || github.event.inputs.force_all == 'true' }}
    continue-on-error: true
    steps:
      - name: Trigger Render Deploy
        if: ${{ secrets.RENDER_DEPLOY_HOOK_URL != '' }}
        run: curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

  # ==========================================================================
  # NEOCITIES (Priority 7)
  # ==========================================================================
  deploy-neocities:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_NEOCITIES == 'true' || github.event.inputs.force_all == 'true' }}
    continue-on-error: true
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: ./dist

      - name: Deploy to Neocities
        uses: bcomnes/deploy-to-neocities@v2
        if: ${{ secrets.NEOCITIES_API_KEY != '' }}
        with:
          api_token: ${{ secrets.NEOCITIES_API_KEY }}
          cleanup: false
          dist_dir: ./dist

  # ==========================================================================
  # FIREBASE HOSTING (Priority 8)
  # ==========================================================================
  deploy-firebase:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_FIREBASE == 'true' || github.event.inputs.force_all == 'true' }}
    continue-on-error: true
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: ./dist

      - name: Create firebase.json
        run: |
          cat > firebase.json << 'EOF'
          {
            "hosting": {
              "public": "dist",
              "ignore": ["firebase.json", "**/.*", "**/node_modules/**"]
            }
          }
          EOF

      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          channelId: live

  # ==========================================================================
  # DENO DEPLOY (Priority 9)
  # ==========================================================================
  deploy-deno:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_DENO == 'true' || github.event.inputs.force_all == 'true' }}
    continue-on-error: true
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: ./dist

      - name: Deploy to Deno Deploy
        uses: denoland/deployctl@v1
        if: ${{ secrets.DENO_DEPLOY_TOKEN != '' }}
        with:
          project: ${{ vars.DENO_PROJECT_NAME || 'chirag-hub' }}
          entrypoint: https://deno.land/std/http/file_server.ts
          root: ./dist

  # ==========================================================================
  # DEPLOYMENT SUMMARY
  # ==========================================================================
  summary:
    needs: [deploy-github-pages, deploy-netlify, deploy-vercel, deploy-cloudflare, deploy-surge, deploy-render, deploy-neocities, deploy-firebase, deploy-deno]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Priority |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Pages | ${{ needs.deploy-github-pages.result }} âœ… | 1 (Always) |" >> $GITHUB_STEP_SUMMARY
          echo "| Netlify | ${{ needs.deploy-netlify.result }} | 2 |" >> $GITHUB_STEP_SUMMARY
          echo "| Vercel | ${{ needs.deploy-vercel.result }} | 3 |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare | ${{ needs.deploy-cloudflare.result }} | 4 |" >> $GITHUB_STEP_SUMMARY
          echo "| Surge.sh | ${{ needs.deploy-surge.result }} | 5 |" >> $GITHUB_STEP_SUMMARY
          echo "| Render | ${{ needs.deploy-render.result }} | 6 |" >> $GITHUB_STEP_SUMMARY
          echo "| Neocities | ${{ needs.deploy-neocities.result }} | 7 |" >> $GITHUB_STEP_SUMMARY
          echo "| Firebase | ${{ needs.deploy-firebase.result }} | 8 |" >> $GITHUB_STEP_SUMMARY
          echo "| Deno Deploy | ${{ needs.deploy-deno.result }} | 9 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Skipped = Platform disabled via ENABLE_* variable" >> $GITHUB_STEP_SUMMARY
